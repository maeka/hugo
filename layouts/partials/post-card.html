{{/* layouts/partials/post-card.html */}}
{{ $p := . }}

{{/* ===== Author (definido SEMPRE no topo, fora de blocos) ===== */}}
{{ $authorName := (site.Params.author.name | default "Ricardo Maekawa") }}
{{ $authorAvatar := "" }}
{{ with site.Params.author.avatar }}{{ $authorAvatar = . }}{{ end }}
{{ if not $authorAvatar }}{{ with site.Params.author.image }}{{ $authorAvatar = . }}{{ end }}{{ end }}

{{/* ===== Thumb: tenta bundle primeiro, depois params.images[0] ===== */}}
{{ $thumb := "" }}
{{ with $p.Resources.GetMatch "*featured*" }}
  {{ $thumb = .RelPermalink }}
{{ else }}
  {{ with $p.Resources.GetMatch "{*cover*,*thumb*,*thumbnail*,*hero*,*.jpg,*.jpeg,*.png,*.webp}" }}
    {{ $thumb = .RelPermalink }}
  {{ end }}
{{ end }}

{{ if not $thumb }}
  {{ with $p.Params.images }}
    {{ if gt (len .) 0 }}{{ $thumb = index . 0 }}{{ end }}
  {{ end }}
{{ end }}

{{ $thumbURL := "" }}
{{ if $thumb }}
  {{ if or (hasPrefix $thumb "http://") (hasPrefix $thumb "https://") }}
    {{ $thumbURL = $thumb }}
  {{ else }}
    {{ $thumbURL = $thumb | relURL }}
  {{ end }}
{{ end }}

<article class="post-card">
  <div class="post-card__main">

    <h3 class="post-card__title">
      <a href="{{ $p.RelPermalink }}">{{ $p.Title }}{{ if $p.Draft }} <sup class="draft-label">DRAFT</sup>{{ end }}</a>
    </h3>

    {{ $subtitle := "" }}
    {{ if isset $p.Params "description" }}
      {{ $subtitle = $p.Description }}
    {{ else if gt (len ($p.Summary | plainify)) 0 }}
      {{ $subtitle = $p.Summary | plainify }}
    {{ end }}

    {{ if $subtitle }}
      <p class="post-card__subtitle">{{ $subtitle }}</p>
    {{ end }}

    <div class="post-card__metaTop">
      <a class="post-card__author" href="{{ relLangURL "about/" }}">
        {{ if $authorAvatar }}
          <img
            class="post-card__authorAvatar"
            src="{{ $authorAvatar | relURL }}"
            alt="{{ $authorName }}"
            loading="lazy"
          />
        {{ end }}
        <span class="post-card__authorName">{{ $authorName }}</span>
      </a>

      <span class="post-card__metaSep">·</span>
      <span class="post-card__dateInline">{{ $p.Date.Format "02 Jan 2006" }}</span>

      {{ $isPT := eq .Site.Language.Lang "pt" }}

      {{ if gt $p.WordCount 0 }}
        <span class="post-card__metaSep">·</span>
        <span class="post-card__metaItem">{{ $p.WordCount }} {{ cond $isPT "palavras" "words" }}</span>
      {{ end }}

      {{ if gt $p.ReadingTime 0 }}
        <span class="post-card__metaSep">·</span>
        <span class="post-card__metaItem">~{{ $p.ReadingTime }} {{ cond $isPT "min de leitura" "min read" }}</span>
      {{ end }}
    </div>

    <div class="post-card__metaBottom">
      {{ with $p.Params.tags }}
        <div class="post-card__tags">
          {{ range . }}
            <a class="tag" href="{{ relLangURL (printf "tags/%s/" (. | urlize)) }}">{{ . }}</a>
          {{ end }}
        </div>
      {{ end }}
    </div>

  </div>

  {{ if $thumbURL }}
    <a class="post-card__thumb"
      href="{{ $p.RelPermalink }}"
      aria-label="Open {{ $p.Title }}"
      style="--thumb:url('{{ $thumbURL }}');">
      <img src="{{ $thumbURL }}" alt="" loading="lazy">
    </a>
  {{ end }}
</article>

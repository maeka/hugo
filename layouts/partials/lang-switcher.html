{{/* layouts/partials/lang-switcher.html */}}

{{ $currentLang := .Site.Language.Lang }}
{{ $currentName := .Site.Language.LanguageName }}

{{/* Lista de destinos:
     - Se a página é traduzida: usa .AllTranslations (inclui a atual)
     - Se não: linka para a HOME de cada idioma
*/}}

<div class="lang-switcher">
  <details class="lang-switcher__details" id="lang-switcher">
    <summary class="lang-switcher__summary" aria-label="Language selector">
      <span class="lang-switcher__icon" aria-hidden="true">
        <i data-feather="globe"></i>
      </span>
      <span class="lang-switcher__label">
        {{ $currentLang | upper }}
      </span>
      <span class="lang-switcher__chev" aria-hidden="true">▾</span>
    </summary>

    <ul class="lang-switcher__menu">
      {{ if .IsTranslated }}
        {{ range .AllTranslations }}
          {{ $isCurrent := eq .Lang $currentLang }}
          <li>
            <a class="lang-switcher__item {{ if $isCurrent }}is-current{{ end }}"
               href="{{ .RelPermalink }}"
               hreflang="{{ .Lang }}">
              {{ .Language.LanguageName }}
            </a>
          </li>
        {{ end }}
      {{ else }}
        {{ range .Site.Languages }}
          {{ $isCurrent := eq .Lang $currentLang }}
          <li>
            <a class="lang-switcher__item {{ if $isCurrent }}is-current{{ end }}"
               href="{{ $.Site.BaseURL }}{{ .Lang }}/"
               hreflang="{{ .Lang }}">
              {{ .LanguageName }}
            </a>
          </li>
        {{ end }}
      {{ end }}
    </ul>
  </details>
</div>

<script>
(() => {
  const details = document.getElementById("lang-switcher");
  if (!details) return;

  // 1) Desliga completamente o comportamento antigo de hover
  // (não adicionamos pointerenter/pointerleave)

  const close = () => details.removeAttribute("open");

  // 2) Fecha ao clicar fora
  document.addEventListener("click", (e) => {
    if (!details.hasAttribute("open")) return;
    if (details.contains(e.target)) return;
    close();
  });

  // 3) Fecha ao apertar ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") close();
  });

  // 4) Fecha ao selecionar uma língua (antes de navegar)
  details.addEventListener("click", (e) => {
    const a = e.target.closest("a.lang-switcher__item");
    if (!a) return;
    close();
  });

    const summary = details.querySelector(".lang-switcher__summary");
  if (!summary) return;

  function syncFixedMenu() {
    // só precisa no mobile
    if (!window.matchMedia("(max-width: 520px)").matches) return;
    if (!details.hasAttribute("open")) return;

    const r = summary.getBoundingClientRect();
    const width = Math.min(240, window.innerWidth - 24);

    details.style.setProperty("--langmenu-top", (r.bottom + 8) + "px");
    details.style.setProperty("--langmenu-width", width + "px");
    details.style.setProperty("--langmenu-left", Math.max(12, r.right - width) + "px");
  }

  // quando abre/fecha
  details.addEventListener("toggle", syncFixedMenu);

  // se rolar ou mudar tamanho enquanto aberto
  window.addEventListener("scroll", syncFixedMenu, { passive: true });
  window.addEventListener("resize", syncFixedMenu, { passive: true });

})();
</script>





